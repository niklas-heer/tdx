name: Update Homebrew Tap

on:
  release:
    types: [published]

jobs:
  update-tap:
    name: Update Homebrew Formula
    runs-on: ubuntu-latest

    steps:
      - name: Checkout tdx repository
        uses: actions/checkout@v4
        with:
          path: tdx

      - name: Checkout homebrew-tap repository
        uses: actions/checkout@v4
        with:
          repository: niklas-heer/homebrew-tap
          token: ${{ secrets.HOMEBREW_TAP_TOKEN }}
          path: homebrew-tap

      - name: Extract version from tag
        id: version
        run: |
          VERSION="${{ github.event.release.tag_name }}"
          VERSION="${VERSION#v}"  # Remove 'v' prefix if present
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

      - name: Update Homebrew formula
        env:
          VERSION: ${{ steps.version.outputs.version }}
          TAP_REPO: ${{ github.workspace }}/homebrew-tap
        run: |
          cd tdx
          chmod +x scripts/update-homebrew.sh
          ./scripts/update-homebrew.sh "$VERSION"

      - name: Commit and push changes
        working-directory: homebrew-tap
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add Formula/tdx.rb

          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "chore: update tdx to v${{ steps.version.outputs.version }}"
            git push
            echo "âœ… Homebrew formula updated and pushed!"
          fi

      - name: Create summary
        run: |
          echo "## ðŸº Homebrew Tap Updated" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Formula updated to version **v${{ steps.version.outputs.version }}**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Repository: [homebrew-tap](https://github.com/niklas-heer/homebrew-tap)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Users can now install with:" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "brew upgrade niklas-heer/tap/tdx" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
